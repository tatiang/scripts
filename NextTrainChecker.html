<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Next SMART Train</title>
  <script>
    let smartSchedule = null; // Will hold the loaded schedule data

    // Station name to stop_id mapping
    const stationNameToId = {
      "Windsor": "71131",
      "Sonoma County Airport": "71121",
      "Santa Rosa North": "71111",
      "Santa Rosa Downtown": "71101",
      "Rohnert Park": "71091",
      "Cotati": "71081",
      "Petaluma Downtown": "71071",
      "Novato Hamilton": "71061",
      "Novato Downtown": "71051",
      "Marin Civic Center": "71041",
      "San Rafael": "71031",
      "Larkspur": "71011"
    };

    // Helper functions
    function timeToSeconds(t) {
      const [h, m, s] = t.split(':').map(Number);
      return h * 3600 + m * 60 + s;
    }

    function formatTime(t) {
      const [h, m] = t.split(':');
      const hour = parseInt(h, 10);
      const suffix = hour >= 12 ? 'PM' : 'AM';
      const formattedHour = ((hour + 11) % 12 + 1);
      return `${formattedHour}:${m} ${suffix}`;
    }

    // Fetch SMART schedule JSON from your GitHub page
    fetch("https://tatiang.github.io/scripts/smart_schedule.json")
      .then(res => res.json())
      .then(data => {
        smartSchedule = data;
        console.log("‚úÖ SMART schedule loaded:", smartSchedule);
      })
      .catch(err => {
        console.error("‚ùå Failed to load SMART schedule:", err);
      });

    // Startup message
    window.addEventListener('DOMContentLoaded', () => {
      const startupMessage = "NextTrainChecker.html script started";
      document.getElementById('result').textContent = startupMessage;
      window.parent.postMessage(startupMessage, "*");
      console.log("‚úÖ Script loaded and ready.");
    });

    // Receive message from Thunkable
    window.addEventListener('message', (event) => {
      console.log("üî• Received message:", event.data);

      try {
        const { date, time, departureStation, arrivalStation } = JSON.parse(event.data);
        if (!smartSchedule) {
          const msg = "‚ùå SMART schedule not yet loaded.";
          document.getElementById('result').textContent = msg;
          window.parent.postMessage(msg, "*");
          return;
        }

        const depCode = stationNameToId[departureStation];
        const arrCode = stationNameToId[arrivalStation];

        if (!depCode || !arrCode) {
          const msg = "‚ùå Invalid station name(s).";
          document.getElementById('result').textContent = msg;
          window.parent.postMessage(msg, "*");
          return;
        }

        let validDepartures = [];

        for (const trip_id in smartSchedule) {
          const calls = smartSchedule[trip_id];
          const depIndex = calls.findIndex(c => c.stop_id === depCode);
          const arrIndex = calls.findIndex(c => c.stop_id === arrCode);

          if (depIndex !== -1 && arrIndex !== -1 && depIndex < arrIndex) {
            const depTime = calls[depIndex].departure_time;
            if (timeToSeconds(depTime) >= timeToSeconds(time)) {
              validDepartures.push(depTime);
            }
          }
        }

        let result = `No departures from ${departureStation} to ${arrivalStation} after ${time} on ${date}`;
        if (validDepartures.length > 0) {
          const next = validDepartures.sort((a, b) => timeToSeconds(a) - timeToSeconds(b))[0];
          result = `Next train from ${departureStation} to ${arrivalStation} after ${time} on ${date}: ${formatTime(next)}`;
        }

        document.getElementById('result').textContent = result;
        window.parent.postMessage(result, "*");

      } catch (error) {
        const errMsg = "‚ùå Error: " + error.message;
        document.getElementById('result').textContent = errMsg;
        window.parent.postMessage(errMsg, "*");
        console.error(errMsg);
      }
    });
  </script>
</head>
<body>
  <h2>SMART Train Departure Checker</h2>
  <p id="result">Waiting for data from Thunkable...</p>
</body>
</html>
