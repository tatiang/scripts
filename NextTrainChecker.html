<!DOCTYPE html>
<html>
<head>
  <title>SMART Train Trip Finder</title>
  <script src="https://thunkable.github.io/webviewer-extension/thunkableWebviewerExtension.js"></script>
</head>
<body>
  <h1>SMART Train Trip Finder</h1>

  <form id="tripForm">
    <label for="date">Date (MM/DD/YY):</label>
    <input type="text" id="date" name="date" required><br><br>

    <label for="time">Earliest Departure Time (HH:MM:SS):</label>
    <input type="text" id="time" name="time" required><br><br>

    <label for="departure">Departure Station:</label>
    <input type="text" id="departure" name="departure" required><br><br>

    <label for="arrival">Arrival Station:</label>
    <input type="text" id="arrival" name="arrival" required><br><br>

    <button type="submit">Find Trips</button>
  </form>

  <pre id="results">Waiting for search...</pre>

  <script>
    console.log("‚úÖ ThunkableWebviewerExtension:", !!window.ThunkableWebviewerExtension);

    const normalize = name => name.replace(/(^SMART\s+|\s+SMART$)/i, '').trim().toLowerCase();

    window.addEventListener("message", function(event) {
      console.log("üì© Message received in WebViewer:", event.data);

      try {
        const data = typeof event.data === "string" ? JSON.parse(event.data) : event.data;
        console.log("üîç Parsed JSON:", data);

        // Populate form
        document.getElementById("date").value = data.date || "";
        document.getElementById("time").value = data.time || "";
        document.getElementById("departure").value = data.departureStation || "";
        document.getElementById("arrival").value = data.arrivalStation || "";

        // Trigger search
        document.getElementById("tripForm").dispatchEvent(new Event('submit'));

      } catch (err) {
        console.error("‚ùå Error parsing message:", err.message);
        document.getElementById("results").textContent = "Invalid input format.";
      }
    });

    document.getElementById("tripForm").addEventListener("submit", function(event) {
      event.preventDefault();

      const date = document.getElementById("date").value;
      const time = document.getElementById("time").value;
      const departureInput = normalize(document.getElementById("departure").value);
      const arrivalInput = normalize(document.getElementById("arrival").value);

      const parts = date.split('/');
      const userDate = new Date(`20${parts[2]}`, parts[0] - 1, parts[1]);

      const resultsEl = document.getElementById("results");
      resultsEl.textContent = "Fetching schedule...";

      fetch("https://tatiang.github.io/scripts/smart_schedule.json")
        .then(res => res.json())
        .then(data => {
          const matches = [];

          for (const [tripId, trip] of Object.entries(data)) {
            if (!trip.stops) continue;

            const startDate = new Date(trip.start_date);
            const endDate = new Date(trip.end_date);
            if (userDate < startDate || userDate > endDate) continue;

            const stops = trip.stops.map(stop => ({
              ...stop,
              normalized_name: normalize(stop.stop_name)
            }));

            const depIndex = stops.findIndex(s => s.normalized_name === departureInput);
            const arrIndex = stops.findIndex(s => s.normalized_name === arrivalInput);

            if (depIndex >= 0 && arrIndex > depIndex) {
              const depTime = stops[depIndex].departure_time;
              if (depTime >= time) {
                matches.push(`${depTime} from ${stops[depIndex].stop_name} to ${stops[arrIndex].stop_name}`);
              }
            }
          }

          const message = matches.length > 0
            ? "‚úÖ Matching Trips:\n" + matches.join('\n')
            : `üö´ No matching trips from ${departureInput} to ${arrivalInput} after ${time} on ${date}`;

          resultsEl.textContent = message;

          if (window.ThunkableWebviewerExtension) {
            console.log("üì§ Posting result back to Thunkable...");
            window.ThunkableWebviewerExtension.postMessage(message);
          }
        })
        .catch(err => {
          const errorMsg = "‚ùå Error: " + err.message;
          resultsEl.textContent = errorMsg;
          if (window.ThunkableWebviewerExtension) {
            window.ThunkableWebviewerExtension.postMessage(errorMsg);
          }
        });
    });
  </script>
</body>
</html>
