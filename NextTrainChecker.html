<!DOCTYPE html>
<html>
<head>
  <title>SMART Train Trip Finder</title>
  <script src="https://thunkable.github.io/webviewer-extension/thunkableWebviewerExtension.js"></script>
</head>
<body>
  <h1>SMART Train Trip Finder</h1>
  <form id="tripForm">
    <label for="date">Date (MM/DD/YY):</label>
    <input type="text" id="date" name="date" value="06/13/25" required><br><br>

    <label for="time">Earliest Departure Time (HH:MM:SS):</label>
    <input type="text" id="time" name="time" value="09:00:00" required><br><br>

    <label for="departure">Departure Station:</label>
    <input type="text" id="departure" name="departure" value="Novato Downtown" required><br><br>

    <label for="arrival">Arrival Station:</label>
    <input type="text" id="arrival" name="arrival" value="Santa Rosa Downtown" required><br><br>

    <button type="submit">Find Trips</button>
  </form>

  <pre id="results">Waiting for search...</pre>

  <script>
    const normalize = name => name.replace(/(^SMART\s+|\s+SMART$)/i, '').trim().toLowerCase();

    // Convert MM/DD/YY string to Date object
    function parseDate(mdyy) {
      const [month, day, year] = mdyy.split('/').map(Number);
      return new Date(2000 + year, month - 1, day); // Handles "25" => 2025
    }

    document.getElementById("tripForm").addEventListener("submit", function(event) {
      event.preventDefault();

      const date = document.getElementById("date").value;
      const time = document.getElementById("time").value;
      const departureInput = normalize(document.getElementById("departure").value);
      const arrivalInput = normalize(document.getElementById("arrival").value);
      const userDate = parseDate(date);

      const resultsEl = document.getElementById("results");
      resultsEl.textContent = "Fetching schedule...";

      fetch("https://tatiang.github.io/scripts/smart_schedule.json")
        .then(res => res.json())
        .then(data => {
          const matches = [];

          for (const [tripId, trip] of Object.entries(data)) {
            if (!trip.stops) continue;

            const startDate = parseDate(trip.start_date);
            const endDate = parseDate(trip.end_date);
            if (userDate < startDate || userDate > endDate) continue;

            const stops = trip.stops.map(stop => ({
              ...stop,
              normalized_name: normalize(stop.stop_name)
            }));

            const depIndex = stops.findIndex(s => s.normalized_name === departureInput);
            const arrIndex = stops.findIndex(s => s.normalized_name === arrivalInput);

            if (depIndex >= 0 && arrIndex > depIndex) {
              const depTime = stops[depIndex].departure_time;
              if (depTime >= time) {
                matches.push(`${depTime} from ${stops[depIndex].stop_name} to ${stops[arrIndex].stop_name}`);
              }
            }
          }

          const message = matches.length > 0
            ? "‚úÖ Matching Trips:\n" + matches.join('\n')
            : `üö´ No departures from ${departureInput} to ${arrivalInput} after ${time} on ${date}`;

          resultsEl.textContent = message;

          if (window.ThunkableWebviewerExtension) {
            window.ThunkableWebviewerExtension.postMessage(message);
          }
        })
        .catch(err => {
          const errorMsg = "‚ùå Error: " + err.message;
          resultsEl.textContent = errorMsg;
          if (window.ThunkableWebviewerExtension) {
            window.ThunkableWebviewerExtension.postMessage(errorMsg);
          }
        });
    });
  </script>
</body>
</html>
