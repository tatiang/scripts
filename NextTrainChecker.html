<!DOCTYPE html>
<html>
<head>
  <script src="https://thunkable.github.io/webviewer-extension/thunkableWebviewerExtension.js"></script>
  <title>SMART Train Trip Finder</title>
</head>
<body>
  <h1>SMART Train Trip Finder</h1>
  <form id="tripForm">
    <label for="date">Date (MM/DD/YY):</label>
    <input type="text" id="date" name="date" value="06/13/25" required><br><br>

    <label for="time">Earliest Departure Time (HH:MM:SS):</label>
    <input type="text" id="time" name="time" value="09:00:00" required><br><br>

    <label for="departure">Departure Station:</label>
    <input type="text" id="departure" name="departure" value="Novato Downtown" required><br><br>

    <label for="arrival">Arrival Station:</label>
    <input type="text" id="arrival" name="arrival" value="Santa Rosa Downtown" required><br><br>

    <button type="submit">Find Trips</button>
  </form>

  <pre id="results"></pre>

  <script>
    const normalize = name => name.replace(/(^SMART\\s+|\\s+SMART$)/i, '').trim().toLowerCase();

    document.getElementById("tripForm").addEventListener("submit", function(event) {
      event.preventDefault();

      const date = document.getElementById("date").value;
      const time = document.getElementById("time").value;
      const departureInput = normalize(document.getElementById("departure").value);
      const arrivalInput = normalize(document.getElementById("arrival").value);
      const userDate = new Date(date);

      fetch("https://tatiang.github.io/scripts/smart_schedule.json")
        .then(res => res.json())
        .then(data => {
          const matches = [];

          for (const [tripId, trip] of Object.entries(data)) {
            if (!trip.stops) continue;

            // Real date filtering
            const startDate = new Date(trip.start_date);
            const endDate = new Date(trip.end_date);
            if (userDate < startDate || userDate > endDate) continue;

            const stops = trip.stops.map(stop => ({
              ...stop,
              normalized_name: normalize(stop.stop_name)
            }));

            const depIndex = stops.findIndex(s => s.normalized_name === departureInput);
            const arrIndex = stops.findIndex(s => s.normalized_name === arrivalInput);

            if (depIndex >= 0 && arrIndex > depIndex) {
              const depTime = stops[depIndex].departure_time;
              if (depTime >= time) {
                matches.push({
                  trip_id: tripId,
                  departure_time: depTime,
                  arrival_time: stops[arrIndex].arrival_time
                });
              }
            }
          }

          const results = document.getElementById("results");
          if (matches.length > 0) {
            results.textContent = "Matching Trips:\n" + JSON.stringify(matches, null, 2);
          } else {
            results.textContent = "ðŸš« No matching trips found.";
          }
        })
        .catch(err => {
          document.getElementById("results").textContent = "Error: " + err.message;
        });
    });
  </script>
</body>
</html>
