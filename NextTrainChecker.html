<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Next SMART Train Checker</title>
  </head>
  <body>
    <div id="result">Loading...</div>

    <script>
      // Normalize station names by adding "SMART " if missing
      function normalizeStationName(name) {
        const knownStations = [
          "Larkspur",
          "San Rafael",
          "Marin Civic Center",
          "Novato Hamilton",
          "Novato Downtown",
          "Novato San Marin",
          "Petaluma Downtown",
          "Petaluma North",
          "Cotati",
          "Rohnert Park",
          "Santa Rosa Downtown",
          "Santa Rosa North",
          "Sonoma County Airport"
        ];

        for (const station of knownStations) {
          if (
            name.toLowerCase().trim() === station.toLowerCase() ||
            name.toLowerCase().trim() === ("SMART " + station).toLowerCase()
          ) {
            return "SMART " + station;
          }
        }

        // Return as-is if not found
        return name;
      }

      function findNextTrain(departureStation, arrivalStation, inputTime, scheduleData) {
        let results = [];

        const normDep = normalizeStationName(departureStation);
        const normArr = normalizeStationName(arrivalStation);

        for (const tripId in scheduleData) {
          const stops = scheduleData[tripId];

          const depIndex = stops.findIndex(s => s.stop_name === normDep);
          const arrIndex = stops.findIndex(s => s.stop_name === normArr);

          if (depIndex >= 0 && arrIndex > depIndex) {
            const depTime = stops[depIndex].departure_time;
            if (depTime > inputTime) {
              results.push({
                tripId,
                departureStation: normDep,
                arrivalStation: normArr,
                departureTime: depTime,
                arrivalTime: stops[arrIndex].arrival_time
              });
            }
          }
        }

        results.sort((a, b) => a.departureTime.localeCompare(b.departureTime));
        return results[0] || null;
      }

      // Receive input via Thunkable Web Viewer
      window.addEventListener("message", event => {
        try {
          const data = JSON.parse(event.data);

          if (!data.date || !data.time || !data.departureStation || !data.arrivalStation) {
            throw new Error("Missing one or more required fields.");
          }

          fetch("https://tatiang.github.io/scripts/smart_schedule.json")
            .then(res => res.json())
            .then(scheduleData => {
              const result = findNextTrain(
                data.departureStation,
                data.arrivalStation,
                data.time,
                scheduleData
              );

              if (result) {
                const message = ✅ Next train departs ${data.departureStation} at ${result.departureTime} and arrives at ${data.arrivalStation} at ${result.arrivalTime}.;
                document.getElementById("result").textContent = message;
                window.parent.postMessage(message, "*");
              } else {
                const message = 🚫 No departures from ${data.departureStation} to ${data.arrivalStation} after ${data.time};
                document.getElementById("result").textContent = message;
                window.parent.postMessage(message, "*");
              }
            });
        } catch (err) {
          const message = ❌ Error: ${err.message};
          document.getElementById("result").textContent = message;
          window.parent.postMessage(message, "*");
        }
      });

      // Signal that the script is ready
      window.addEventListener("DOMContentLoaded", () => {
        const startupMessage = "NextTrainChecker.html script started";
        document.getElementById("result").textContent = startupMessage;
        window.parent.postMessage(startupMessage, "*");
      });
    </script>
  </body>
</html>
