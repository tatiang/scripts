<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>NextTrainChecker</title>
    <script src="https://thunkable.github.io/webviewer-extension/thunkableWebviewerExtension.js"></script>
  </head>
  <body>
    <div id="result">🔄 Waiting for input...</div>

    <script>
      const normalize = name =>
        name.replace(/(^SMART\\s+|\\s+SMART$)/i, '').trim().toLowerCase();

      function parseDate(mmddyy) {
        const [mm, dd, yy] = mmddyy.split("/");
        return new Date(`20${yy}`, mm - 1, dd);
      }

      function handleMessage(data) {
        const { date, time, departureStation, arrivalStation } = data;
        const normDep = normalize(departureStation);
        const normArr = normalize(arrivalStation);
        const userDate = parseDate(date);

        fetch("https://tatiang.github.io/scripts/smart_schedule.json")
          .then(res => res.json())
          .then(schedule => {
            const results = [];

            for (const trip of Object.values(schedule)) {
              const { start_date, end_date, stops } = trip;
              if (!stops) continue;

              const start = parseDate(start_date);
              const end = parseDate(end_date);
              if (userDate < start || userDate > end) continue;

              const mapped = stops.map(s => ({
                ...s,
                _name: normalize(s.stop_name)
              }));

              const depIdx = mapped.findIndex(s => s._name === normDep);
              const arrIdx = mapped.findIndex(s => s._name === normArr);

              if (depIdx >= 0 && arrIdx > depIdx) {
                const depTime = mapped[depIdx].departure_time;
                if (depTime >= time) {
                  results.push(
                    `${depTime} from ${mapped[depIdx].stop_name} to ${mapped[arrIdx].stop_name}`
                  );
                }
              }
            }

            results.sort();
            const msg = results.length
              ? "✅ Matching trips:\n" + results.join("\n")
              : `🚫 No departures from ${departureStation} to ${arrivalStation} after ${time} on ${date}`;

            document.getElementById("result").textContent = msg;
            if (window.ThunkableWebviewerExtension) {
              window.ThunkableWebviewerExtension.postMessage(msg);
            }
          })
          .catch(err => {
            const msg = `❌ Error: ${err.message}`;
            document.getElementById("result").textContent = msg;
            if (window.ThunkableWebviewerExtension) {
              window.ThunkableWebviewerExtension.postMessage(msg);
            }
          });
      }

      // Listen for message from Thunkable
      if (window.ThunkableWebviewerExtension) {
        window.ThunkableWebviewerExtension.receiveMessage(message => {
          try {
            const data = JSON.parse(message);
            console.log("🔍 Received:", data);
            handleMessage(data);
          } catch (e) {
            const errMsg = "❌ Invalid JSON: " + e.message;
            document.getElementById("result").textContent = errMsg;
            window.ThunkableWebviewerExtension.postMessage(errMsg);
          }
        });
      }

      // Ready confirmation
      document.addEventListener("DOMContentLoaded", () => {
        const msg = "✅ NextTrainChecker.html loaded and ready.";
        console.log(msg);
        document.getElementById("result").textContent = msg;
        if (window.ThunkableWebviewerExtension) {
          window.ThunkableWebviewerExtension.postMessage(msg);
        }
      });
    </script>
  </body>
</html>
