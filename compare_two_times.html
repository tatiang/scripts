<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Include the Thunkable Web Viewer Extension -->
    <script src="https://thunkable.github.io/webviewer-extension/thunkableWebviewerExtension.js" type="text/javascript"></script>
    <title>Time Comparator</title>
  </head>
  <body>
    <script type="text/javascript">
      // Function to parse a time string.
      // Accepts "HH:MM:SS" or "(H)H:MM" (seconds default to 0 if omitted).
      function parseTime(timeStr) {
        // Log the raw input.
        console.log("Raw timeStr:", timeStr);
        // Remove any characters that are not digits or colon.
        timeStr = timeStr.replace(/[^\d:]/g, "").trim();
        console.log("Cleaned timeStr:", timeStr);
        const parts = timeStr.split(':');
        console.log("Split parts:", parts);
        if (parts.length < 2 || parts.length > 3) {
          throw new Error("Invalid time format. Expected HH:MM or HH:MM:SS.");
        }
        const hour = parseInt(parts[0], 10);
        const minute = parseInt(parts[1], 10);
        // If seconds are provided, use them; otherwise assume 0.
        const second = parts.length === 3 ? parseInt(parts[2], 10) : 0;
        console.log("Parsed numbers:", { hour, minute, second });
        // Validate that each part is a valid number.
        if (isNaN(hour) || isNaN(minute) || isNaN(second)) {
          throw new Error("Time parts must be valid numbers.");
        }
        // Validate that minutes and seconds are in valid ranges.
        if (minute < 0 || minute > 59 || second < 0 || second > 59) {
          throw new Error("Minutes and seconds must be between 0 and 59.");
        }
        return hour * 3600 + minute * 60 + second;
      }

      // Function to compare two times.
      // Returns -1 if time1 comes before time2, 1 if time1 comes after time2, and 0 if equal.
      function compareTimes(time1, time2) {
        const t1Seconds = parseTime(time1);
        const t2Seconds = parseTime(time2);
        if (t1Seconds < t2Seconds) {
          return -1;
        } else if (t1Seconds > t2Seconds) {
          return 1;
        } else {
          return 0;
        }
      }

      // Function to compute the duration difference (in minutes) between two times.
      function calculateDuration(time1, time2) {
        const t1Seconds = parseTime(time1);
        const t2Seconds = parseTime(time2);
        const diffSeconds = Math.abs(t2Seconds - t1Seconds);
        const diffMinutes = Math.floor(diffSeconds / 60);
        return diffMinutes + " minutes";
      }

      // Combined message processor.
      function processMessage(message) {
        console.log("Raw message received:", message);
        // Trim whitespace.
        message = message.trim();

        // Remove wrapping quotes if the message is surrounded by them.
        if (message.startsWith('"') && message.endsWith('"')) {
          message = message.substring(1, message.length - 1).trim();
        }
        console.log("Message after trimming/quote removal:", message);

        // Check if the message starts with "duration" (case-insensitive).
        if (message.toLowerCase().startsWith("duration")) {
          // Remove the "duration" prefix and trim.
          message = message.substring("duration".length).trim();
          console.log("After removing 'duration' prefix:", message);
          const parts = message.split('#');
          if (parts.length !== 2) {
            return "Error: Provide two times separated by '#' after 'duration'.";
          }
          const time1 = parts[0].trim();
          const time2 = parts[1].trim();
          console.log("Duration times:", { time1, time2 });
          return calculateDuration(time1, time2);
        } else {
          // Assume message is of format "time1#time2".
          const parts = message.split('#');
          if (parts.length !== 2) {
            return "Error: Provide two times separated by '#'.";
          }
          const time1 = parts[0].trim();
          const time2 = parts[1].trim();
          console.log("Comparison times:", { time1, time2 });
          const result = compareTimes(time1, time2);
          if (result === -1) {
            return "time1";
          } else if (result === 1) {
            return "time2";
          } else {
            return "equal";
          }
        }
      }

      // Message handler expecting a return value.
      ThunkableWebviewerExtension.receiveMessageWithReturnValue(function(message, callback) {
        try {
          const resultMessage = processMessage(message);
          callback(resultMessage);
        } catch (error) {
          callback("Error: " + error.message);
        }
      });

      // Message handler for messages that don't expect a return value.
      ThunkableWebviewerExtension.receiveMessage(function(message) {
        try {
          const resultMessage = processMessage(message);
          ThunkableWebviewerExtension.postMessage(resultMessage);
        } catch (error) {
          ThunkableWebviewerExtension.postMessage("Error: " + error.message);
        }
      });

      // Post-load initialization.
      window.onload = function() {
        console.log("Time comparator loaded and ready.");
      };
    </script>
  </body>
</html>
