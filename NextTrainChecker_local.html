<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>NextTrainChecker â€“ no duplicates</title>
  <script src="https://thunkable.github.io/webviewer-extension/thunkableWebviewerExtension.js"></script>
  <style>body{font-family:sans-serif;margin:1rem;font-size:15px}</style>
</head>
<body>
  <div id="status">âœ… Bridge loaded â€“ waitingâ€¦</div>

  <script>
  /*--- CONFIG ---*/
  const LOCAL = true;                             // true if bundled as asset
  const SCHEDULE_URL = LOCAL ? "./smart_schedule.json"
                             : "https://tatiang.github.io/scripts/smart_schedule.json";

  /*--- helpers ---*/
  const norm = n => n.replace(/(^SMART\s+|\s+SMART$)/i,"").trim().toLowerCase();
  const parseDate = d => { const [m,day,yy] = d.split("/").map(Number);
                           return new Date(yy<100?2000+yy:yy, m-1, day); };

  // round down to minute â†’ "HH:MM:00"
  const roundTime = t => t.slice(0,5)+":00";

  function post(obj){
    const txt = obj.summary || JSON.stringify(obj);
    document.getElementById("status").textContent = txt;
    if(window.ThunkableWebviewerExtension){
      window.ThunkableWebviewerExtension.postMessage(JSON.stringify(obj));
    }
  }

  function findTrips(q, schedule){
    const userDate = parseDate(q.date);
    const depN = norm(q.departureStation);
    const arrN = norm(q.arrivalStation);

    const seen = new Set();          // for de-duplication
    const trips = [];

    for(const trip of Object.values(schedule)){
      if(!trip.stops) continue;
      const start = parseDate(trip.start_date);
      const end   = parseDate(trip.end_date);
      if(userDate < start || userDate > end) continue;

      const stops = trip.stops.map(st=>({...st,_n:norm(st.stop_name)}));
      const iDep = stops.findIndex(st=>st._n===depN);
      const iArr = stops.findIndex(st=>st._n===arrN);
      if(iDep<0 || iArr<=iDep) continue;

      const rawDep = stops[iDep].departure_time;
      if(rawDep < q.time) continue;

      const dep = roundTime(rawDep);
      const arr = roundTime(stops[iArr].arrival_time);
      const key = dep+"-"+arr;       // de-dup key

      if(seen.has(key)) continue;    // duplicate â†’ skip
      seen.add(key);

      trips.push({
        departure:dep,
        arrival:arr,
        from:stops[iDep].stop_name,
        to:stops[iArr].stop_name
      });
    }

    trips.sort((a,b)=>a.departure.localeCompare(b.departure));
    if(trips[0]) trips[0].next = true;
    return trips;
  }

  /*--- handler ---*/
  async function handle(raw){
    let q; try{ q=typeof raw==="string"?JSON.parse(raw):raw; }
    catch(e){ post({summary:"âŒ Bad JSON"}); return; }

    if(!["date","time","departureStation","arrivalStation"].every(k=>k in q)){
      post({summary:"âŒ Missing field"}); return;
    }
    post({summary:"ðŸ”„ Fetching scheduleâ€¦"});

    try{
      const schedule = await fetch(SCHEDULE_URL).then(r=>r.json());
      const trips = findTrips(q,schedule);

      post({
        summary: trips.length?`âœ… ${trips.length} trip(s) found`
                             : `ðŸš« No trips after ${q.time} on ${q.date}`,
        trips
      });
    }catch(err){
      post({summary:"âŒ Fetch error: "+err.message});
    }
  }

  /*--- wiring ---*/
  if(window.ThunkableWebviewerExtension){
    window.ThunkableWebviewerExtension.receiveMessage(handle);
  }
  window.addEventListener("message",e=>handle(e.data));
  console.log("âœ… NextTrainChecker ready (local =", LOCAL, ")");
  </script>
</body>
</html>
