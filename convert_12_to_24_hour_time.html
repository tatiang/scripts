<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Time Converter</title>
    <!-- Include the Thunkable Web Viewer Extension script -->
    <script src="https://thunkable.github.io/webviewer-extension/thunkableWebviewerExtension.js" type="text/javascript"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        text-align: center;
      }
      #status {
        margin-top: 20px;
        color: green;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h2>Time Converter</h2>
    <div id="status">Waiting for input...</div>
  </body>
  <script type="text/javascript">
    console.log("Script loaded");

    // Function to convert time to 24-hour format
    function convertTo24HourFormat(inputTime) {
      let [time, period] = inputTime.split(" ");
      let [hours, minutes] = time.split(":").map(Number);

      if (period.toUpperCase() === "PM" && hours !== 12) {
        hours += 12;
      } else if (period.toUpperCase() === "AM" && hours === 12) {
        hours = 0;
      }

      let formattedHours = String(hours).padStart(2, "0");
      let formattedMinutes = String(minutes).padStart(2, "0");

      return `${formattedHours}:${formattedMinutes}`;
    }

    // When the screen initializes, post messages to the web bridge and web viewer
    function onScreenOpen() {
      console.log("Screen opened, sending messages...");
      ThunkableWebviewerExtension.postMessage('dragon');
      ThunkableWebviewerExtension.postMessage('unicorn');
    }

    // Function to handle incoming messages that expect a return value
    ThunkableWebviewerExtension.receiveMessageWithReturnValue(function(message, callback) {
      const response = 'demo: ' + message;
      console.log("Received message with return value:", message);
      callback(response);
    });

    // Handle incoming messages that do not expect a return value
    ThunkableWebviewerExtension.receiveMessage(function(message) {
      const statusDiv = document.getElementById("status");
      statusDiv.textContent = "Received message from app: " + message;
      console.log("Received message without return value:", message);

      try {
        const inputTime = message.trim();

        // Validate input format using regex
        if (!/^\d{1,2}:\d{2}\s?(AM|PM)$/i.test(inputTime)) {
          throw new Error("Invalid format! Use HH:MM AM/PM.");
        }

        // Perform conversion
        const convertedTime = convertTo24HourFormat(inputTime.toUpperCase());

        // Update status on the webpage (optional)
        statusDiv.textContent = `Converted Time: ${convertedTime}`;

        // Send converted time back to Thunkable app
        ThunkableWebviewerExtension.postMessage(convertedTime);
      } catch (error) {
        // Update status with error message
        statusDiv.textContent = `Error: ${error.message}`;

        // Send error message back to Thunkable app
        ThunkableWebviewerExtension.postMessage(`Error: ${error.message}`);
      }
    });

    // Call the onScreenOpen function when the script loads
    window.onload = onScreenOpen;
  </script>
</html>
