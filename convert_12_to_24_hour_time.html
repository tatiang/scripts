<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Include the Thunkable Web Viewer Extension -->
    <script src="https://thunkable.github.io/webviewer-extension/thunkableWebviewerExtension.js" type="text/javascript"></script>
    <title>Thunkable Web Bridge Demo</title>
  </head>
  <body>
    <script type="text/javascript">
      // Function to convert time to 24-hour format
      function convertTo24HourFormat(inputTime) {
        let [time, period] = inputTime.split(" ");
        let [hours, minutes] = time.split(":").map(Number);

        if (period.toUpperCase() === "PM" && hours !== 12) {
          hours += 12;
        } else if (period.toUpperCase() === "AM" && hours === 12) {
          hours = 0;
        }

        let formattedHours = String(hours).padStart(2, "0");
        let formattedMinutes = String(minutes).padStart(2, "0");

        return `${formattedHours}:${formattedMinutes}`;
      }

      // When the screen initializes, post messages to the web bridge and web viewer
      function onScreenOpen() {
        ThunkableWebviewerExtension.postMessage('dragon');
        ThunkableWebviewerExtension.postMessage('unicorn');
      }

      // Function to handle incoming messages that expect a return value
      ThunkableWebviewerExtension.receiveMessageWithReturnValue(function(message, callback) {
        try {
          let inputTime = message.trim().replace(/\s+/g, " ");
          console.log(`Raw input received: "${inputTime}"`);

          // Validate input format using regex
          if (!/^\d{1,2}:\d{2}\s(AM|PM)$/i.test(inputTime.toUpperCase())) {
            // Attempt to parse using Date object for edge cases
            const parsedTime = new Date(`1970-01-01T${inputTime}`);
            if (isNaN(parsedTime)) {
              throw new Error("Invalid format! Use HH:MM AM/PM.");
            }
            inputTime = parsedTime.toLocaleTimeString("en-US", { hour: '2-digit', minute: '2-digit', hour12: true });
          }

          // Perform conversion
          const convertedTime = convertTo24HourFormat(inputTime.toUpperCase());

          // Send converted time back as the callback response
          callback(convertedTime);
        } catch (error) {
          // Send error message back as the callback response
          callback(`Error: ${error.message}`);
        }
      });

      // Handle incoming messages that do not expect a return value
      ThunkableWebviewerExtension.receiveMessage(function(message) {
        try {
          let inputTime = message.trim().replace(/\s+/g, " ");
          console.log(`Raw input received: "${inputTime}"`);

          // Validate input format using regex
          if (!/^\d{1,2}:\d{2}\s(AM|PM)$/i.test(inputTime.toUpperCase())) {
            // Attempt to parse using Date object for edge cases
            const parsedTime = new Date(`1970-01-01T${inputTime}`);
            if (isNaN(parsedTime)) {
              throw new Error("Invalid format! Use HH:MM AM/PM.");
            }
            inputTime = parsedTime.toLocaleTimeString("en-US", { hour: '2-digit', minute: '2-digit', hour12: true });
          }

          // Perform conversion
          const convertedTime = convertTo24HourFormat(inputTime.toUpperCase());

          // Send converted time back to Thunkable app
          ThunkableWebviewerExtension.postMessage(convertedTime);
        } catch (error) {
          // Send error message back to Thunkable app
          ThunkableWebviewerExtension.postMessage(`Error: ${error.message}`);
        }
 
